<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Docker-btrfs by anokun7</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Docker-btrfs</h1>
      <h2 class="project-tagline">Working with docker on btrfs as the backend storage filesystem</h2>
      <a href="https://github.com/anokun7/docker-btrfs" class="btn">View on GitHub</a>
      <a href="https://github.com/anokun7/docker-btrfs/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/anokun7/docker-btrfs/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h3><a id="about-btrfs" class="anchor" href="#about-btrfs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>About Btrfs and Docker.</h3>

<p>Btrfs (pronounced better-fs) is a highly advanced and fully stable Linux file system that offers many compelling and useful features like Copy-On-Write, snapshotting, Raiding, and thin provisioning. Btrfs is the default filesystem on some systems like Suse / SLES and is being used by some very large financial organizations today. Within Docker, support for Btrfs is available in the form of a storage driver as of 1.10 (both open source and commercially supported versions). While Suse / SLES include btrfs as the default filesystem, it can be installed on almost every other linux flavor like Debian / Ubuntu and Red Hat / Centos systems. With the problems we see in using devicemapper and questions as to devicemapper's maintainability given that OverlayFS seems to be gaining more focus and attention, btrfs seems like a very good replacement for devicemapper on Red Hat based systems as Docker's preferred storage driver.</p>

<h3><a id="working-with-btrfs" class="anchor" href="#working-with-btrfs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Working with Btrfs</h3>

<p>In the sections below, we shall see how easy it is to work with Btrfs and specifically how to recover from disk out-of-space issues.</p>
<p>What we'll use here is a stock Ubuntu 14.04.3 LTS system. We'll install Docker 1.11, the Btrfs package, configure Docker to use btrfs as the storage driver. We will then simulate a disk out-of-space issue and then look at steps to recover from it without losing any data or applications running on the system. For the purposes of understanding all commands are typed out by hand, and it is urged that these manual steps are automated to make the entire recovery process more reliable.</p>

<h3><a id="start-with-btrfs" class="anchor" href="#start-with-btrfs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Btrfs Quickstart</h3>
<ol>
  <li> <p>Let's login to our Ubuntu 14.04 box and check if btrfs is installed and available. Since, we will be dealing with making changes to filesystems it will be convenient to run all commands as root (or use sudo to prefix all commands).</p>
  <pre><code>root@m1-host:-# btrfs
The program 'btrfs' is currently not installed. You can install it by typing:
apt-get install btrfs-tools
root@m1-host:-#</code></pre>
  <p>Expectedly, btrfs is not installed on this Ubuntu system<p></li>
  <li><p>Let's install btrfs as shown in the output message above</p>
  <pre><code>root@m1-host:-# apt-get install btrfs-tools
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following extra packages will be installed:
  liblzo2-2
The following NEW packages will be installed:
  btrfs-tools liblzo2-2
0 upgraded, 2 newly installed, 0 to remove and 91 not upgraded.
Need to get 380 kB of archives.
After this operation, 2,692 kB of additional disk space will be used.
Do you want to continue? [Y/n]
Get:1 http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ trusty-updates/main liblzo2-2 amd64 2.06-1.2ubuntu1.1 [46.1 kB]
Get:2 http://us-east-1.ec2.archive.ubuntu.com/ubuntu/ trusty-updates/main btrfs-tools amd64 3.12-1ubuntu0.1 [334 kB]
Fetched 380 kB in 0s (18.3 MB/s)
Selecting previously unselected package liblzo2-2:amd64.
(Reading database ... 62083 files and directories currently installed.)
Preparing to unpack .../liblzo2-2_2.06-1.2ubuntu1.1_amd64.deb ...
Unpacking liblzo2-2:amd64 (2.06-1.2ubuntu1.1) ...
Selecting previously unselected package btrfs-tools.
Preparing to unpack .../btrfs-tools_3.12-1ubuntu0.1_amd64.deb ...
Unpacking btrfs-tools (3.12-1ubuntu0.1) ...
Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
Setting up liblzo2-2:amd64 (2.06-1.2ubuntu1.1) ...
Setting up btrfs-tools (3.12-1ubuntu0.1) ...
update-initramfs: deferring update (trigger activated)
Processing triggers for libc-bin (2.19-0ubuntu6.6) ...
Processing triggers for initramfs-tools (0.103ubuntu4.2) ...
update-initramfs: Generating /boot/initrd.img-3.13.0-87-generic
root@m1-host:-#</code></pre></li>
  <li><p>Now the btrfs command should work:</p>
  <pre><code>root@m1-host:-# btrfs --version
Btrfs v3.12
root@m1-host:-#</code></pre></li>
  <li><p>Also, ensure that the current version of docker is installed. The simplest way to get docker up and running is <code>curl -fsSL https://get.docker.com | sh</code></p></li>
  <li><p>Btrfs works with block devices, so we would need one. Let's see what all block devices are attached to this system, using the <code>lsblk</code> command:</p>
  <pre></code>root@m1-host:-# lsblk
NAME    MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
xvda    202:0    0   8G  0 disk
└─xvda1 202:1    0   8G  0 part /
root@m1-host:-#</code></pre>
  <p>There are no unpartitioned block devices on this system. The only one is the one on which the OS is installed. We need to add another one.</p>
  <p>Since this is an AWS instance, I'm attaching two EBS instances, each 4GB in size.</p>
  <p>Running <code>lsblk</code> command now should reflect the new block devices added.</p>
  <pre><code>root@m1-host:-# lsblk
NAME    MAJ:MIN  RM SIZE RO TYPE MOUNTPOINT
xvda    202:0     0   8G  0 disk
└─xvda1 202:1     0   8G  0 part /
xvdx    202:5888  0   4G  0 disk
xvdy    202:5888  0   4G  0 disk
root@m1-host:-#</code></pre></li>
  <li><p>We need to change docker to use <code>btrfs</code> as the storage driver. Currently (as the default on Ubuntu), docker is using <code>extfs</code> as indicated by the output of <code>docker info | grep -i filesystem</code></p>
  <pre></code>root@m1-host:-# docker info | grep Filesystem
WARNING: No swap limit support
 Backing Filesystem: extfs
root@m1-host:-#</code></pre>
  <p>So, let's shut down docker before we make any changes using <code>service docker stop</code>.</p>
  <p><i>Note: This is assuming that this is a brand new docker installation and there are no images that need to be preserved. If there are, then those images would need to be either pushed to the hub / DTR or exported into tar files and backed up in some fashion.</i></p></li>
</ol>

<h3><a id="getting-docker-to-use-btrfs" class="anchor" href="#getting-docker-to-use-btrfs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Getting Docker to use Btrfs</h3>
<ol>
  <li><p>Let's format the first disk <code>xvdx</code> to use the btrfs filesystem. The wonderful aspect of this exercise is that btrfs behaves as a logical volume manager and as such there is no need to partition the disk or anything. We could partition the disk if we really wanted to, and not because btrfs needed it. We'll use <code>mkfs.btrfs</code> for this task.</p>
  <pre><code>root@m1-host:-# mkfs.btrfs -f /dev/xvdx

WARNING! - Btrfs v3.12 IS EXPERIMENTAL
WARNING! - see http://btrfs.wiki.kernel.org before using

Turning ON incompat feature 'extref': increased hardlink limit per file to 65536
fs created label (null) on /dev/xvdx
  nodesize 16384 leafsize 16384 sectorsize 4096 size 4.00GiB
Btrfs v3.12
root@m1-host:-#</code></pre></li>
  <li><p>Now that the btrfs filesystem has been created, let's mount it on the same path that docker uses as the root for all containers, images and volumes on the host which is <code>/var/lib/docker</code>.</p>
  <pre><code>root@m1-host:-# df -lkh
Filesystem      Size  Used Avail Use% Mounted on
udev            3.9G   12K  3.9G   1% /dev
tmpfs           799M  392K  799M   1% /run
/dev/xvda1      7.8G  3.1G  4.3G  43% /
none            4.0K     0  4.0K   0% /sys/fs/cgroup
none            5.0M     0  5.0M   0% /run/lock
none            3.9G     0  3.9G   0% /run/shm
none            100M     0  100M   0% /run/user
root@m1-host:-# mount /dev/xvdx /var/lib/docker
root@m1-host:-# df -lkh
Filesystem      Size  Used Avail Use% Mounted on
udev            3.9G   12K  3.9G   1% /dev
tmpfs           799M  392K  799M   1% /run
/dev/xvda1      7.8G  3.1G  4.3G  43% /
none            4.0K     0  4.0K   0% /sys/fs/cgroup
none            5.0M     0  5.0M   0% /run/lock
none            3.9G     0  3.9G   0% /run/shm
none            100M     0  100M   0% /run/user
/dev/xvdx       4.0G  320K  3.6G   1% /var/lib/docker
root@m1-host:-#</code></pre></li>
  <li><p>Running <code>docker info</code> after bringing the docker daemon back up should reflect that docker is indeed using the <code>btrfs</code> (as the) storage driver.</p>
  <pre><code>root@m1-host:-# service docker start
docker start/running, process 30840
root@m1-host:-# docker info | grep -i storage
WARNING: No swap limit support
Storage Driver: btrfs
root@m1-host:-#</code></pre><li>
  </ol>
<h3>
<a id="creating-pages-manually" class="anchor" href="#creating-pages-manually" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Creating pages manually</h3>

<p>If you prefer to not use the automatic generator, push a branch named <code>gh-pages</code> to your repository to create a page manually. In addition to supporting regular HTML content, GitHub Pages support Jekyll, a simple, blog aware static site generator. Jekyll makes it easy to create site-wide headers and footers without having to copy them across every page. It also offers intelligent blog support and other advanced templating features.</p>

<h3>
<a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Authors and Contributors</h3>

<p>You can <a href="https://help.github.com/articles/basic-writing-and-formatting-syntax/#mentioning-users-and-teams" class="user-mention">@mention</a> a GitHub username to generate a link to their profile. The resulting <code>&lt;a&gt;</code> element will link to the contributor’s GitHub Profile. For example: In 2007, Chris Wanstrath (<a href="https://github.com/defunkt" class="user-mention">@defunkt</a>), PJ Hyett (<a href="https://github.com/pjhyett" class="user-mention">@pjhyett</a>), and Tom Preston-Werner (<a href="https://github.com/mojombo" class="user-mention">@mojombo</a>) founded GitHub.</p>

<h3>
<a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Support or Contact</h3>

<p>Having trouble with Pages? Check out our <a href="https://help.github.com/pages">documentation</a> or <a href="https://github.com/contact">contact support</a> and we’ll help you sort it out.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/anokun7/docker-btrfs">Docker-btrfs</a> is maintained by <a href="https://github.com/anokun7">anokun7</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
